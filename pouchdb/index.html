<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#9f00a7">
    <link rel="manifest" href="/pouchdb/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/pouchdb/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/pouchdb/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/pouchdb/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/pouchdb/favicon-16x16.png" sizes="16x16">
    <link rel="mask-icon" href="/pouchdb/safari-pinned-tab.svg" color="#40aa54">
    <meta name="msapplication-TileColor" content="#1b00a3">
    <meta name="msapplication-TileImage" content="/pouchdb/mstile-144x144.png">

    <title>PouchDB test</title>

    <script type="text/javascript">
      (function(a,b,c,d,e){if(c in b&&b[c]){var g,f=a.location;f.pathname!==d&&(!(g=f.search.slice(1).split("&")).length||g.indexOf(e)<0)&&(f.href=d);var h,i=/^(a|html)$/i;a.addEventListener("click",function(a){for(h=a.target;!i.test(h.nodeName);)h=h.parentNode;"href"in h&&(chref=h.href).replace(f.href,"").indexOf("#")&&(!/^[a-z\+\.\-]+:/i.test(chref)||0===chref.indexOf(f.protocol+"//"+f.host))&&(a.preventDefault(),f.href=h.href+(h.href.indexOf("?")>-1?"&":"?")+e)},!1)}})(document,window.navigator,"standalone","/index.html","ios_homescreen=1");

      /**
       * Registering a service worker, if the browser provides support
       */
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/pouchdb/service-worker.js', {
            scope: '.' // <--- THIS BIT IS REQUIRED
          }).then(function(registration) {
            // Registration was successful
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }).catch(function(err) {
            // registration failed :(
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
      /**
       * end
       */
    </script>

    <script src="//cdn.jsdelivr.net/npm/pouchdb@7.1.1/dist/pouchdb.min.js"></script>

    <style>
      body {
       font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
     }
    </style>

  </head>
  <body>

    <h1>PouchDB test</h1>

    <ul>
      <li>IOS standalone mode : <b id="webapp_ios">OFF</b></li>
      <li>W3C standalone mode : <b id="webapp_manifest">OFF</b></li>
      <li>Storage :
        <ul>
          <li>Persistent : <b id="storage_persistent">Not available</b></li>
          <li>Estimate : <b id="storage_estimate">Not available</b>
            <p id="storage_details"></p>
          </li>
        </ul>
      </li>
      <li>PouchDB :
        <ul>
          <li style="list-style: none;">
            <button id="syncPouchDBBtn" onclick="syncPouchDB()">Sync remote =&gt; local</button>
          </li>
          <li>Nb of documents on local : <b id="pouch_doc_local">Not available</b></li>
          <li>Nb of documents on remote : <b id="pouch_doc_remote">Not available</b></li>
          <li style="list-style: none;">
            <button id="addDocumentsBtn" onclick="addDocuments()">Add Documents</button>
          </li>
        </ul>
      </li>
    </ul>

    <script type="text/javascript">
      // Detect IOS standalone mode
      if (window.navigator.standalone) {
        document.querySelector('#webapp_ios').innerHTML = 'ON';
      }

      // Detect a Webapp defined via a standard manifest (using the parameter added in the `starturl`)
      if (window.matchMedia('(display-mode: standalone)').matches) {
        document.querySelector('#webapp_manifest').innerHTML = 'ON';
      }

      // Print storage information
      function bytesToString(bytesCount) {
        const kCoef = Math.pow(2, 10);
        const mCoef = Math.pow(kCoef, 2);
        const gCoef = Math.pow(kCoef, 3);
        if (bytesCount < kCoef) return bytesCount + 'b';
        if (bytesCount < mCoef) return (bytesCount / kCoef).toFixed(2) + 'kb';
        if (bytesCount < gCoef) return (bytesCount / mCoef).toFixed(2) + 'mb';
        return (bytesCount / gCoef).toFixed(2) + 'gb';
      }

      // Transforms usage details to an HTML string
      function usageDetailsToString(usageDetails) {
        if (!usageDetails || !Object.keys(usageDetails).length) return 'No storage details';
        return Object.entries(usageDetails)
          .map(function([type, bytes]) { return 'â€¢ ' + type + ': ' + bytesToString(bytes); })
          .join('<br>');
      }

      // Updates the storage usage estimate on screen
      function updateStorageEstimate() {
        if ('storage' in navigator) {
          if ('persist' in navigator.storage) {
            navigator.storage.persist().then(granted => {
              document.querySelector('#storage_persistent').innerHTML = granted ? 'Yes' : 'No';
            });
          }
          if ('estimate' in navigator.storage) {
          navigator.storage.estimate()
            .then(function(estimate) {
              document.querySelector('#storage_estimate').innerHTML = 'Using ' + bytesToString(estimate.usage) + ' out of ' + bytesToString(estimate.quota);
              if ('usageDetails' in estimate)
                document.querySelector('#storage_details').innerHTML = usageDetailsToString(estimate.usageDetails);
            });
          }
        }
      }

      updateStorageEstimate();
      setInterval(updateStorageEstimate, 3000);

      // PouchDB

      var dbName = 'people';
      var localDB = new PouchDB(dbName);
      var remoteDB = new PouchDB('https://68f4937c-cf60-483d-bb7c-f534b0ceb44b-bluemix.cloudantnosqldb.appdomain.cloud/' + dbName, {
        auth: {
          username: 'entsemdquedichadeforyour',
          password: '9c150f507065e32ea22217534a002c3ae40f3183'
        }
      });
      var syncPouchDBBtn = document.getElementById('syncPouchDBBtn');
      
      function refreshDocCount(db, htmlElementId) {
        if (isAddingDocuments) return;
        db.info()
          .then(function(result) {
            console.info(result);
            document.getElementById(htmlElementId).innerHTML = result.doc_count;
          })
          .catch(console.error);
      }

      refreshDocCount(localDB, 'pouch_doc_local');
      refreshDocCount(remoteDB, 'pouch_doc_remote');
      setInterval(function() { refreshDocCount(localDB, 'pouch_doc_local') }, 3000 );
      // setInterval(function() { refreshDocCount(remoteDB, 'pouch_doc_remote') }, 10000 );

      function syncPouchDB() {
        syncPouchDBBtn.disabled = true;
        localDB.replicate.from(remoteDB)
          .on('change', function(info) {
              // handle change
              console.info('[pouchdb] Replication change', info);
          })
          .on('paused', function(err) {
              // replication paused (e.g. replication up to date, user went offline)
              console.info('[pouchdb] Replication paused', err);
              syncPouchDBBtn.innerHTML = 'Sync paused';
          })
          .on('active', function() {
              // replicate resumed (e.g. new changes replicating, user went back online)
              console.info('[pouchdb] Replication active');
              syncPouchDBBtn.innerHTML = 'Sync active...';
          })
          .on('denied', function(err) {
              // a document failed to replicate (e.g. due to permissions)
              console.info('[pouchdb] Replication denied', err);
              syncPouchDBBtn.innerHTML = 'Sync denied';
              syncPouchDBBtn.disabled = false;
          })
          .on('complete', function(info) {
              // handle complete
              console.info('[pouchdb] Replication complete', info);
              syncPouchDBBtn.innerHTML = 'Sync complete!';
              syncPouchDBBtn.disabled = false;
          })
          .on('error', function(err) {
              // handle error
              console.info('[pouchdb] Replication error', err);
              document.querySelector('#storage_details').innerHTML = 'Sync error! :-(';
              syncPouchDBBtn.disabled = false;
          });
      }

      // Add more local Documents to PouchDB

      var addDocumentsBtn = document.getElementById('addDocumentsBtn');
      var nbRuns = 0;
      var keysNbPerRun = 1000;
      var isAddingDocuments = false;

      function addDocuments() {
        isAddingDocuments = true;
        addDocumentsBtn.disabled = true;
        nbRuns++;
        var nb = keysNbPerRun;
        var promiseChain = Promise.resolve();

        var makeNextPromise = function(currentNumber) {
          return function() {
            var uuid = (()=>([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,a=>(a^Math.random()*16>>a/4).toString(16)))();
            return localDB.put({
              _id: uuid,
              nb: 'test-' + (nbRuns * keysNbPerRun + currentNumber),
              lorem: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec eleifend mi sit amet nibh suscipit, a rhoncus diam pellentesque. In euismod eros et accumsan cursus. Suspendisse eu auctor ex. Mauris feugiat lacus metus, ac dictum odio lacinia vitae. Maecenas pretium metus nunc. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Suspendisse at metus id ante mollis scelerisque. In eu consequat est. Sed vel nibh in felis consectetur commodo. Sed et ultricies tortor, non suscipit nunc. Sed vitae cursus odio. Pellentesque luctus ante vitae quam vehicula, ac interdum felis fringilla. Suspendisse potenti. Donec eu libero nec leo auctor pellentesque sed vitae tellus. Vestibulum feugiat venenatis nisl. Cras in semper libero. Praesent eu risus id nunc tristique viverra. Quisque tristique diam velit, eu sollicitudin ligula aliquet non. Vivamus sagittis lorem libero, non elementum odio egestas a. Quisque libero eros, consequat et ipsum id, pretium convallis felis. Donec tincidunt mattis sem, eu rutrum sem suscipit nec. Aenean porttitor urna at imperdiet molestie. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Praesent feugiat ligula iaculis ex commodo scelerisque. Nulla facilisi. Suspendisse accumsan ut sem nec luctus. Nunc tempor commodo nisl quis fermentum. Sed tristique eget nunc in auctor. Nunc sodales nibh et augue efficitur mattis. Ut fermentum orci eget dignissim rhoncus. Cras sagittis risus nibh, eu bibendum nulla luctus et. Curabitur et eros et tellus bibendum dictum in nec urna. Phasellus quis dui imperdiet turpis tempus hendrerit. Duis vulputate tempor est vel viverra. Maecenas lacus neque, molestie at scelerisque et, tempor vel augue. Integer ex ipsum, ullamcorper non imperdiet vitae, placerat eu dolor. Donec non feugiat ex, nec tincidunt urna. Donec vel lobortis sem, id scelerisque felis. Ut consectetur pretium hendrerit. Cras a nisl ipsum. Aenean id ligula pulvinar, laoreet nisi eu, mattis augue. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Suspendisse ut cursus ante. Donec nisl mi, ultrices vitae justo quis, ultricies vestibulum felis. Curabitur vitae neque ut massa mattis aliquam fermentum eu odio. Donec faucibus ligula lorem, maximus aliquet orci pulvinar a. Donec eu mi pretium, cursus lacus ut, mollis lacus. Aenean augue nisi, elementum quis lorem vitae, viverra rutrum eros. Aliquam pellentesque tempus congue. Aliquam erat volutpat. Morbi ultricies elementum metus, ut scelerisque purus venenatis et. Etiam risus nunc, faucibus cursus odio ullamcorper, vestibulum ornare velit. Suspendisse rutrum rutrum justo, eget pharetra eros. Maecenas eget lectus eget dolor varius eleifend eget ut magna. Donec lobortis convallis egestas. Nulla rutrum est non nulla malesuada, vel eleifend mauris finibus. Pellentesque id nisi tellus. Nullam vitae risus lacinia, dignissim orci sit amet, gravida elit. Sed dapibus lorem arcu, eu feugiat mi imperdiet eu. Praesent est lectus, accumsan sed nulla vel, lobortis vehicula urna. Etiam diam massa, dignissim ac mollis sit amet, egestas quis arcu. Cras sit amet leo massa. Phasellus maximus, massa sit amet lobortis porttitor, justo odio cursus ante, sed porta neque tellus sed sapien. Proin aliquam cursus leo, vel tempus orci tincidunt quis. Suspendisse consequat massa non mi fermentum egestas. Morbi tristique venenatis urna id tempor. Nulla sollicitudin lacinia nunc, at dictum mi facilisis vitae. Sed ipsum ante, sodales eu molestie vel, pharetra sed ex. Nam vulputate accumsan volutpat. Mauris risus sem, auctor vitae ullamcorper a, mollis sit amet nisl. Praesent ac hendrerit lacus. Nam commodo mattis neque in porttitor. Mauris magna orci, sagittis at nibh nec, efficitur ultricies ex. Cras odio eros, aliquam non orci quis, tempor faucibus diam. Aenean aliquam velit sed justo tincidunt, in tincidunt est tempor. Donec nec nulla malesuada, molestie ipsum eu, scelerisque orci. Mauris non eros et eros malesuada euismod in nec ipsum. Fusce faucibus nulla in leo pellentesque elementum. Nam varius tincidunt sapien a rhoncus. Proin non ligula est. Suspendisse bibendum metus a ullamcorper interdum. Etiam sed volutpat dolor, eu maximus erat. Aliquam erat volutpat. Fusce pharetra tellus ut est ullamcorper fringilla. Mauris rutrum ultrices lacinia. Mauris viverra gravida porta. Quisque imperdiet cursus ultricies. Mauris tristique turpis sed nisl laoreet, sed blandit nulla venenatis. Quisque eu posuere metus. Mauris laoreet, risus eu semper efficitur, nisi sem interdum urna, non facilisis ante nibh a est. Cras quis arcu faucibus, commodo dolor ac, lobortis purus. Aliquam erat volutpat. Morbi mattis justo non consectetur blandit. Donec dictum nunc id enim blandit mattis. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Sed finibus congue dolor sed mollis. Sed id sodales metus, eu egestas nisl. Nulla in velit vel eros euismod lobortis ac vel ipsum. Donec maximus tellus libero, ac gravida nisi semper vitae. Duis elit metus, pellentesque ac arcu nec, aliquam pharetra eros. Quisque pharetra purus at ex venenatis placerat. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean hendrerit porttitor arcu, non efficitur metus. Nunc mattis erat sed dui auctor, a sodales est lobortis. Phasellus laoreet erat sed leo varius faucibus. Integer tincidunt pharetra lobortis. Integer cursus sem sit amet mattis iaculis. Nullam mi nunc, accumsan ac erat venenatis, malesuada vestibulum sem. Fusce efficitur leo metus, ac luctus metus semper nec. Donec semper, erat in dictum hendrerit, sapien elit tempus nisi, a semper nibh nunc nec libero. In tempor vel nulla ut elementum. Aliquam sit amet sem at elit aliquam dapibus. Curabitur posuere tempor porttitor. Proin et venenatis ipsum. Cras convallis nec augue at iaculis.',
            })
            .then(console.debug)
            .catch(console.error);
          }
        }

        while (nb) {
          promiseChain = promiseChain.then(makeNextPromise(nb))
          nb--;
        }

        promiseChain.then(function() {
          isAddingDocuments = false;
          addDocumentsBtn.disabled = false;
          console.info('Done adding documents.');
        });
      }
    </script>

  </body>
</html>
